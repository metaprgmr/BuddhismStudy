<html>
<head>
<meta charset="utf-8">
<title>念佛节奏計算器</title>
<link rel="stylesheet" href="../util/article.css">
<style>
th { background-color:lightgray }
#msg { font-size:14px }
</style>
<script src="registry.js"></script>
<script src="../util/utils.js"></script>
</head>
<body><center>

<div class="content">

<h2 align="center" style="text-align:center; margin-bottom:10px">念佛节奏計算器</h2>

<script>
  var hoursToPlay = get('hours') || get('hrs') || 4;
  var buf = new Buffer();

  var targets = [ 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24 ]; // 萬
  var hours   = [  8, 10, 12, 16, 18, 20, 22, 24 ];
  function getBPM(target, hours) { return (target * 10000) / (hours * 60); }

  var ttl = '【根據目標次數計算最低念佛節奏（每分鐘次數）】',
      calc = '<u>念佛次數 = bpm*60*小時數</u></caption>';
  buf.w(`<center><table bgcolor=white cellspacing="3px"><caption>${ttl}　${calc}</caption>`,
        '<tr><th aligth=right>目標次數：</th>');
  for (var i in targets) 
    buf.w(`<th>${targets[i]}萬</th>`);
  buf.w('</tr>');
  for (var j in hours) {
    var hrs = hours[j];
    buf.w(`<tr><td bgcolor=lightgray align=right>${hrs}小時：</td>`);
    for (var i in targets) {
      var bpm = getBPM(targets[i], hrs);
      if (bpm > 195 || bpm <= 30)
        buf.w(`<td align=right style="opacity:0.3"><i>${bpm.toFixed(0)}</i></td>`);
      else if (bpm >= 140)
        buf.w(`<td align=right style="color:red">${bpm.toFixed(0)}</td>`);
      else if (bpm > 114)
        buf.w(`<td align=right style="color:blue">${bpm.toFixed(0)}</td>`);
      else
        buf.w(`<td align=right>${bpm.toFixed(0)}</td>`);
    }
    buf.w('</tr>');
  }
  buf.w('</table></center>');
  buf.render(document);

  ttl = '【根據念佛節奏（每分鐘次數）計算每天念佛次數】';
  var bpms = [ 60, 90, 100, 120, 130, 140, 150, 160, 170, 180, 190, 200 ];
  buf.w('<br><a name="metronome"></a>',
        `<center><table bgcolor=white cellspacing="3px"><caption>${ttl}　${calc}</caption>`,
        '<tr><th align=right>BPM：</th>');
  for (var i in bpms) {
    var bpm = bpms[i];
    if (bpm < 170) buf.w(`<th>${bpm}</th>`);
    else buf.w(`<th style="color:red">${bpm}</th>`);
  }
  buf.w('</tr>');
  for (var hrs=4; hrs<=24; hrs+=2) {
    buf.w(`<tr><td bgcolor=lightgray align=right>&nbsp;${hrs}小時：</td>`);
    for (var i in bpms) {
      var bpm = bpms[i];
      var cnt = bpm * 60 * hrs / 10000, disp = `${cnt.toFixed(1)}萬`;
      if (cnt > 19.7)
        buf.w(`<td align=right style="color:red">${disp}</td>`);
      else if (cnt > 14.7)
        buf.w(`<td align=right style="color:blue">${disp}</td>`);
      else if (cnt > 9.7)
        buf.w(`<td align=right style="color:green">${disp}</td>`);
      else
        buf.w(`<td align=right>${disp}</td>`);
    }
    buf.w('</tr>');
  }
  buf.w('</table></center>');
  buf.render(document);
</script>
<br>
<center><table bgcolor=white cellspacing="3px"><caption>【生成的節拍器試聽】</caption>
<tr><th align=right>音調：</th>
<script>
var clipDur = 5; // minutes
var prevID, playNum, curBPM, uri;
function audioEndCB(event) {
  var perClip = curBPM * clipDur, perHr = curBPM * 60,
      totalPlays = hoursToPlay * 60 / clipDur;
  if (playNum > totalPlays) return;
  if (++playNum > totalPlays) {
    renderText('msg', `${hoursToPlay}小時播放終了。總計${hoursToPlay*perHr}次。`);
    event.target.currentTime = 0;
    event.target.src = '../images/鈴鼓.mp3';
    event.target.play();
    return;
  }
  event.target.currentTime = 0;
  event.target.play();
  renderText('msg', uri + `（${perClip}拍；${perHr}拍/時）第${playNum}輪`);
}
function playMetron(tune, bpm) {
  var newID = `_${bpm}_${tune}`;
  if (newID == prevID) return;
  if (prevID) e(prevID).style.backgroundColor = null;
  prevID = newID;
  playNum = 1;
  curBPM = bpm;
  e(prevID).style.backgroundColor = 'pink';
  uri = `./metronomes/metron${tune}-${bpm}-5m_.mp3`;
  var a = e('audiop');
  showEl(a);
  a.src = uri;
  a.play();
  console.log('bpm:', bpm, ' clipDur:', clipDur, ' hours:', hoursToPlay,
              ' rounds:', hoursToPlay * 60 / clipDur,
              '\ntotalBeats:', bpm * 60 * hoursToPlay);
  renderText('msg', uri + `（${bpm*5}拍；${bpm*60}拍/時）將播放${hoursToPlay}小時`);
}

  var tunes = [ '板','C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4' ];
  var bpms = [ 120, 140, 150, 160, 170, 175, 180, 185, 190, 195, 200 ];
  for (var i in tunes)
    buf.w('<th>', tunes[i], '</th>');
  buf.w('</tr>');
  for (var i in bpms) {
    var bpm = bpms[i];
    if (bpm > 160)
      buf.w('<tr><td bgcolor=lightgray>&nbsp;<red>', bpm, '</red>拍/分：</td>');
    else
      buf.w('<tr><td bgcolor=lightgray>&nbsp;', bpm, '拍/分：</td>');
    for (var j in tunes) {
      var t = tunes[j];
      if (t == '板') t = '';
      if ((bpm == 120) || (bpm == 180) || (t == '') || (t[0] == 'A'))
        buf.w(`<td id="_${bpm}_${t}"><a href="javascript:playMetron('${t}', ${bpm})">聽</a></td>`);
      else
        buf.w('<td></td>');
    }
    buf.w('</tr>');
  }
  buf.w('</table><div id="msg">五分鐘，可循迴</div>',
        '<audio controls id="audiop" style="width:436px; margin-top:2px; display:none"></center>');
  buf.render(document);
  e('audiop').addEventListener('ended', audioEndCB);
</script>

<h3 style="text-align:center; margin-bottom:-10px">生成節拍器音聲文件</h3>

<p>這些音聲是由tools/gen-metronome.sh（需要 Java）生成的。它只生成WAV；這裡用ffmpeg轉成mp3。不然，自己想辦法。節拍生成器的使用方法如下：</p>
<pre style="background-color:white; font-size:14px; padding-left:10px">
tools$ gen-metronome.sh 
Usage: gen-metronome.sh outFile bpm dur beat
  where: outFile is the output WAV file name.
         bpm     is an integer for beats-per-minute.
         dur     is duration; can end with 's' (seconds) or 'm' (minutes).
                 Further, if ends with '_', the last 10 beats will be softer.
         beat    can be a file name, or a note frequency such as 440.
A few examples:
    gen-metronome.sh metron-120-5m.wav    120 5m  ../images/metrobeat.wav
or: gen-metronome.sh metronA4-125-5m_.wav 125 5m_ 440
or: gen-metronome.sh metronA4-125-30.wav  125 30  440
or: gen-metronome.sh metronA3-140-30.wav  140 30s 220

For your quick reference, the frequencies of musical notes are:
  C4=261.6 D4=293.7 E4=329.6 F4=349.2 G4=392 A4=440 B4=493.9
</pre>
<script>
  endOfArticle('251107');
</script>
</center></body></html>
